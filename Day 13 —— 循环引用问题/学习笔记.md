### ä¸€ã€ä»€ä¹ˆæ˜¯å¾ªç¯å¼•ç”¨ï¼Ÿï¼ˆä¸€å¥è¯ç‰ˆï¼‰

> **ä¸¤ä¸ªæˆ–å¤šä¸ªå¯¹è±¡ï¼Œç”¨ `shared_ptr` å½¼æ­¤æŒæœ‰ï¼Œå¯¼è‡´å¼•ç”¨è®¡æ•°æ°¸è¿œä¸ä¸º 0**

ç»“æœï¼š

* ææ„å‡½æ•°æ°¸è¿œä¸è°ƒç”¨
* èµ„æºæ°¸è¿œä¸é‡Šæ”¾
* âŒ å†…å­˜æ³„æ¼

---

### äºŒã€å¾ªç¯å¼•ç”¨ä¸ºä»€ä¹ˆåªä¼šå‡ºç°åœ¨ shared_ptrï¼Ÿ

å› ä¸ºï¼š

* `shared_ptr` ä¾èµ– **å¼•ç”¨è®¡æ•°**
* åªæœ‰å½“è®¡æ•°ä¸º 0ï¼Œèµ„æºæ‰ä¼šé‡Šæ”¾

è€Œå¾ªç¯ç»“æ„ä¸­ï¼š

```
A â†’ B
â†‘   â†“
â””â”€â”€â”€â”˜
```

ğŸ‘‰ **æ¯ä¸ªå¯¹è±¡éƒ½åœ¨â€œä¿æ´»â€å¯¹æ–¹**ã€‚

---

### ä¸‰ã€ç°åœºæ„é€ ï¼šshared_ptr æ³„æ¼ç¤ºä¾‹ï¼ˆå¿…ä¼šï¼‰

```cpp
#include <memory>
#include <iostream>

struct B;

struct A {
    std::shared_ptr<B> b;
    ~A() { std::cout << "A destroyed\n"; }
};

struct B {
    std::shared_ptr<A> a;
    ~B() { std::cout << "B destroyed\n"; }
};

int main() {
    auto a = std::make_shared<A>();
    auto b = std::make_shared<B>();

    a->b = b;
    b->a = a;
}
```

### âŒ è¿è¡Œç»“æœ

* ç¨‹åºç»“æŸ
* **æ²¡æœ‰ä»»ä½•ææ„è¾“å‡º**

è¯´æ˜ï¼š

* `A` å’Œ `B` çš„å¼•ç”¨è®¡æ•°å§‹ç»ˆ â‰¥ 1

---

### å››ã€ä¸ºä»€ä¹ˆâ€œçœ‹èµ·æ¥æ²¡é—®é¢˜â€ï¼Ÿï¼ˆæœ¬è´¨å‰–æï¼‰

ä»¥ `a` ä¸ºä¾‹ï¼š

* `main` ä¸­ï¼š1 æ¬¡å¼•ç”¨
* `b->a` ä¸­ï¼š1 æ¬¡å¼•ç”¨

å³ä½¿ `main` ç»“æŸï¼š

* `a` çš„å¼•ç”¨è®¡æ•°ä»ä¸º 1

ğŸ‘‰ **shared_ptr æ— æ³•åˆ¤æ–­â€œè¿™æ˜¯ç¯â€**ã€‚

---

### äº”ã€è§£å†³åŸåˆ™ï¼ˆå¿…é¡»è®°ä½ï¼‰

> **åœ¨ä¸€ä¸ªâ€œç¯â€ä¸­ï¼Œå¿…é¡»æœ‰ä¸€æ¡è¾¹ä¸æ‹¥æœ‰èµ„æº**

æ¢å¥è¯è¯´ï¼š

* åªèƒ½æœ‰ä¸€ä¸ªâ€œçœŸæ­£çš„æ‰€æœ‰è€…â€
* å…¶ä½™åªèƒ½æ˜¯â€œè§‚å¯Ÿè€…â€

---

### å…­ã€weak_ptr çš„è§’è‰²å®šä½

`weak_ptr`ï¼š

* ä¸å¢åŠ å¼•ç”¨è®¡æ•°
* ä¸æ§åˆ¶å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ
* åªèƒ½â€œè§‚å¯Ÿâ€å¯¹è±¡æ˜¯å¦è¿˜æ´»ç€

ğŸ‘‰ å®ƒå°±æ˜¯ä¸ºäº†è§£å†³ **shared_ptr å¾ªç¯å¼•ç”¨** è€Œå­˜åœ¨çš„ã€‚

---

### ä¸ƒã€ç”¨ weak_ptr ä¿®å¤å¾ªç¯å¼•ç”¨ï¼ˆæ ‡å‡†è§£æ³•ï¼‰

```cpp
struct B;

struct A {
    std::shared_ptr<B> b;
    ~A() { std::cout << "A destroyed\n"; }
};

struct B {
    std::weak_ptr<A> a;   // ğŸ”¥ æ”¹è¿™é‡Œ
    ~B() { std::cout << "B destroyed\n"; }
};

int main() {
    auto a = std::make_shared<A>();
    auto b = std::make_shared<B>();

    a->b = b;
    b->a = a;
}
```

### âœ… è¿è¡Œç»“æœ

```
A destroyed
B destroyed
```

---

### å…«ã€ä¸ºä»€ä¹ˆ weak_ptr ä¸€å®šè¦é…åˆ lockï¼Ÿ

```cpp
if (auto sp = wp.lock()) {
    // å¯¹è±¡ä»ç„¶å­˜åœ¨
}
```

åŸå› ï¼š

* `weak_ptr` ä¸ä¿è¯èµ„æºå­˜åœ¨
* ä½¿ç”¨å‰å¿…é¡»ç¡®è®¤å¯¹è±¡æœªè¢«é‡Šæ”¾

---

### ä¹ã€å·¥ç¨‹çº§è®¾è®¡åŸåˆ™ï¼ˆéå¸¸é‡è¦ï¼‰

> **æ ‘ / å›¾ / åŒå‘å…³ç³»ä¸­ï¼š**
>
> * ä¸€è¾¹ç”¨ shared_ptrï¼ˆæ‹¥æœ‰ï¼‰
> * å¦ä¸€è¾¹å¿…é¡»ç”¨ weak_ptrï¼ˆè§‚å¯Ÿï¼‰

---
